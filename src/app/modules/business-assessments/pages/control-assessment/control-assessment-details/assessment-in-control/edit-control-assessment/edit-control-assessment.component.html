<main class="mt-3 acl-page cpf-space-adjust db-small-space-boxes v2-new-design">
    <div class="" *mobxAutorun>
        <app-details-control-assessment-loader *ngIf="!ControlAssessmentDetailsStore?.details_loaded"></app-details-control-assessment-loader>
      <div class="row sm-row" *ngIf="ControlAssessmentDetailsStore?.details_loaded">
            <div class="col-sm-12 sm-col">
              <div class="bg-white btm-space-10 widg-padding-cmn-small">
                  <div class="row sm-row align-items-center">
                      <div class="col-lg-6 col-sm-12 sm-col">
                          <!-- <div class="mb-3">
                              <button type="button" class="btn btn-sm btn-active font-weight-600">In Progress</button><span class="sm-text pl-2 mr-2">PDF | 17 MB</span><button type="button" class="btn-icon"><i class="fas fa-arrow-alt-to-bottom"></i></button>
                          </div>
                          <h6 class="mb-0-sm-3">ISO 9001 QMS (Quality Management System)</h6> -->

                          <h6>{{ControlAssessmentDetailsStore?.indiviaulControlAssessment?.title}}
                            <span  [ngClass]="'draft-tag-'+ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_status?.label" 
                            class="draft-tag label-tag-style-tag label-left-arow-tag d-inline-block status-tag-new-one">
                                {{ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_status?.language[0]?.pivot?.title}}</span>
                            </h6>
                          <div class="mb-0-sm-3">
                            
                              <span *ngIf="ControlAssessmentDetailsStore?.assessmentDocumentVersionData?.document_version_size" class="sm-text pl-0 mr-2" style="text-transform: uppercase;">
                               
                                {{ControlAssessmentDetailsStore?.assessmentDocumentVersionData?.document_version_ext}} | {{ControlAssessmentDetailsStore?.assessmentDocumentVersionData?.document_version_size/1048576 | number:'0.2-2'}}MB</span>

                                <span *ngIf="!ControlAssessmentDetailsStore?.assessmentDocumentVersionData?.document_version_size" class="sm-text pl-0 mr-2" style="text-transform: uppercase;">
                               
                                    {{ControlAssessmentStore?.docDetails?.ext}} | {{ControlAssessmentStore?.docDetails?.size/1048576 | number:'0.2-2'}}MB</span>
                                
                                <button (click)="doewnloadDocument()" type="button" class="btn-icon"><i class="fas fa-arrow-alt-to-bottom"></i></button>
                          </div>

                      </div>
                      <div class="col-lg-6 col-sm-12 sm-col">
                          <div class="row sm-row">
                              <div class="col-md-5 sm-col">
                                <p class="mb-0-sm-3 text-color-four">{{'cyber_you_have_completed'|translate}} <br><span class="bold text-black">{{ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completed_control_count?ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completed_control_count:'0'}}
                                    /
                                    {{ControlAssessmentDetailsStore?.indiviaulControlAssessment?.total_control_count?ControlAssessmentDetailsStore?.indiviaulControlAssessment?.total_control_count:'0'}}</span> Controls</p>  
                              </div>
                              <div class="col-md-7 sm-col">
                                  <div class="dot-progress">
                                      <div class="d-flex"> 
                                          <p class="small-p mb-0 w-100">{{'completion' | translate}}</p>
                                          <span class="bold text-14 text-green pl-3">{{ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completion_percentage?ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completion_percentage:'0'}}%</span>
                                      </div>
                                      <div class="progress">
                                          <div class="progress-inner-dot">
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span class="active"></span>
                                              <span></span>
                                          </div>
                                        <div *ngIf="ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completion_percentage" class="progress-bar bg-green progress-bar-animation" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" 
                                        [ngStyle]="{'max-width': ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completion_percentage+'%'}"></div>

                                        <div *ngIf="!ControlAssessmentDetailsStore?.indiviaulControlAssessment?.completion_percentage" class="progress-bar bg-green progress-bar-animation" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" 
                                        [ngStyle]="{'max-width': '0%'}"></div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="w-100  sm-row" *ngIf="ControlAssessmentDetailsStore?.details_loaded&&ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_document_version_contents.length==0">
        <app-no-data [border]="false"></app-no-data>
      </div>
              
      <div class="row sm-row" *ngIf="ControlAssessmentDetailsStore?.details_loaded&&ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_document_version_contents.length">
          <div class="col-lg-3 col-sm-12 sm-col">
              <div class="bg-white btm-space-10 widg-padding-cmn-small pt-3 pb-3">
                  <div class="form-group form-group-h-36 mb-0">
                      <form class="form-control issue-select-process-search bg-white search-popup-new">
                         <input [(ngModel)]="searchKeyword" type="text" placeholder="{{'cyber_search_main_clause' | translate}}" name="search" class="search-process">
                         <span style="cursor: pointer;" (click)="resetFilter()" *ngIf="searchKeyword" class="search-clear-btn">X</span>
                         <button (click)="searchClause()" type="submit" style="width: 40px;"><i class="fa fa-search"></i></button>
                      </form>
                   </div>
              </div>
          </div>
          <div class="col-lg-9 col-sm-12 sm-col">
              <div class="bg-white btm-space-10 widg-padding-cmn-small pt-3 pb-3">
                  <div class="row sm-row align-items-center">
                      <div class="col-lg-2   col-sm-12 sm-col">
                          <h5 class="font-normal text-13 mb-0-sm-3"><i class="far fa-sliders-h mr-2"></i>{{'cyber_sort_filter' | translate}}</h5>
                      </div>
                      <div class="col-lg-7 col-sm-12 sm-col">
                          <div class="row sm-row">
                              <div class="col-lg-4 col-sm-12 sm-col assesment-select remove-ng-arrow">
                               <div class="input-group border-input-group mb-0-sm-3">
                                    <div class="input-group-prepend">
                                      <label class="input-group-text" for="inputGroupSelect01">Clause</label>
                                    </div>
                                    <div class="custom-select-icon">
                                        
                                        <ng-select [items]="childClauses"
                                        [placeholder]="'cyber_select_clause'|translate" [multiple]="false" searchable="true"
                                        bindLabel="document_version_content_title" 
                                        (open)="getChildClausesList()"
                                        (clear)="getChildClausesList()"
                                        (search)="getChildClausesList($event)"
                                        [(ngModel)]="control_assessment_document_version_content_ids"
                                        [closeOnSelect]="true" autocomplete="new-password">
                                        <!-- <ng-option [value]="type.id"
                                            *ngFor="let type of childClauses">
                                            {{type.document_version_content_title}}
                                        </ng-option> -->
                                        <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                            {{item?.document_version_content_title?.length > 7 ?
                                            (item.document_version_content_title | slice:0:7)+' ...' :
                                            item.document_version_content_title}}<span aria-hidden="true"
                                                style="border:none;"
                                                class="ng-value-icon left">×</span>
                                        </ng-template>
                                        <ng-template ng-option-tmp let-item="item" let-index="index">
                                            {{item?.document_version_content_title?.length > 50 ?
                                            (item.document_version_content_title | slice:0:50)+' ...' :
                                            item.document_version_content_title}}
                                        </ng-template>
                                    </ng-select>
                                    </div>
                                  </div>
                              </div>
                              <div class="col-lg-4 col-sm-12 sm-col assesment-select remove-ng-arrow" [ngStyle] = "{'pointer-events': !control_assessment_document_version_content_ids ? 'none' : ''}">
                                  <div class="input-group border-input-group mb-0-sm-3">
                                    <div class="input-group-prepend">
                                      <label class="input-group-text" for="inputGroupSelect01">{{'framework'| translate}}</label>
                                    </div>
                                    <div class="custom-select-icon">
                                        <ng-select 
                                        [items]="ControlAssessmentDetailsStore?.indiviaulControlAssessment?.business_assessment_framework?.business_assessment_framework_options"
                                        [placeholder]="'cyber_select_evaluation'|translate" [multiple]="false" searchable="true"
                                        bindLabel="title" 
                                        [(ngModel)]="business_assessment_framework_option_ids"
                                        [closeOnSelect]="true" autocomplete="new-password">
                                        <!-- <ng-option [value]="type.id"
                                        *ngFor="let type of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.business_assessment_framework?.business_assessment_framework_options">
                                        {{type.title}}
                                        </ng-option> -->
                                        <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                            {{item?.title?.length > 7 ?
                                            (item.title | slice:0:7)+' ...' :
                                            item.title}}<span aria-hidden="true"
                                                style="border:none;"
                                                class="ng-value-icon left">×</span>
                                        </ng-template>
                                        <ng-template ng-option-tmp let-item="item" let-index="index">
                                            {{item?.title?.length > 50 ?
                                            (item.title | slice:0:50)+' ...' :
                                            item.title}}
                                        </ng-template>
                                    </ng-select>
                                    </div>
                                  </div>
                              </div>
                              <div class="col-lg-4 col-sm-12 sm-col assesment-select remove-ng-arrow" [ngStyle] = "{'pointer-events': !control_assessment_document_version_content_ids ? 'none' : ''}">
                                  <div class="input-group border-input-group mb-0-sm-3">
                                    <div class="input-group-prepend">
                                      <label class="input-group-text" for="inputGroupSelect01"> {{'level'| translate}}</label>
                                    </div>
                                    <div class="custom-select-icon">
                                        <ng-select 
                                        [items]="ControlAssessmentDetailsStore?.indiviaulControlAssessment?.maturity_model?.maturity_model_levels"
                                        [placeholder]="'cyber_select_answer'|translate" [multiple]="false" searchable="true"
                                        bindLabel="title" 
                                        [(ngModel)]="maturity_model_level_ids"
                                        [closeOnSelect]="true" autocomplete="new-password">
                                        <!-- <ng-option [value]="type.id"
                                            *ngFor="let type of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.maturity_model?.maturity_model_levels">
                                            {{type.title}}
                                        </ng-option> -->
                                        <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                            {{item?.title?.length > 7 ?
                                            (item.title | slice:0:7)+' ...' :
                                            item.title}}<span aria-hidden="true"
                                                style="border:none;"
                                                class="ng-value-icon left">×</span>
                                        </ng-template>
                                        <ng-template ng-option-tmp let-item="item" let-index="index">
                                            {{item?.title?.length > 50 ?
                                            (item.title | slice:0:50)+' ...' :
                                            item.title}}
                                        </ng-template>
                                    </ng-select>
                                    </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-3 col-sm-12 sm-col">
                          <button (click)="filter()" type="button" class="btn-new mr-1">{{'cyber_apply_filter' | translate}}</button>
                          <button (click)="resetFilter()" type="button" class="btn-new ">{{'cyber_reset_filter' | translate}}</button>
                      </div>
                  </div>
              </div>
          </div>
      </div>




      <div class="audit-program-box audit-page-table-main" *ngIf="ControlAssessmentDetailsStore?.details_loaded&&ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_document_version_contents.length">
          <div class="row">
             <div class="col-sm-12">
                  <div class="table-dashboard-hidden-border-scroll relative">
                      <!-- <div class="left-right-round-btns btn-left-right-0">
                          <button type="button" id="left-button" class="btn-left"></button>
                          <button type="button" id="right-button" class="btn-right"></button>
                      </div> -->
                      <app-framework-loader *ngIf="!assessmentLoader"></app-framework-loader>
                      <div class="w-100  sm-row" *ngIf="assessmentLoader&& controlDetails.length==0 || (filterApplied && controlDetails[0]['control_assessment_document_version_content_controls'].length==0)">
                        <app-no-data [border]="false"></app-no-data>
                      </div>
                      <div *ngIf="assessmentLoader&& controlDetails.length && controlDetails[0]['control_assessment_document_version_content_controls'].length"class="full-width-table table-dashboard table-margin-minus hover-td-color" id="content-process">
                        <table class="mb-1">
                           <thead>
                              <tr>
                                  <th style="width: 14%;">{{'cyber_main_clause' | translate}}</th>
                                  <th style="width: 14%;"> {{'cyber_sub_clause' | translate}}</th>
                                  <th style="width: 14%;"> {{'cyber_child_clauses' | translate}}</th>
                                  <th style="width: 19%;">{{'control' | translate}}</th>
                                  <th style="width: 10%;">{{'cyber_framework_option' | translate}}</th>
                                  <th style="width: 13%;">{{'cyber_current_maturity' | translate}}</th>
                                  <th style="width: 6%;" class="text-center">{{'score' | translate}}</th>
                                  <th style="width: 10%;" class="text-center">{{'cyber_action_plan_count' | translate}}</th>
                                  <!-- <th colspan="3" style="width: 28%;">Assessment</th> -->
                              </tr>
                           </thead>
                           <tbody>
                            <ng-container *ngFor="let row of controlDetails;let i = index">
                                <ng-container *ngIf="row.control_assessment_document_version_content_controls.length>0">
                                    <!-- {{row?.control_assessment_document_version_content_controls[0]?.control?.title}} -->
                                    <tr  *ngFor="let item of row.control_assessment_document_version_content_controls.slice(0, 1)">
                                    
                                        <td [attr.rowspan]="row.control_assessment_document_version_content_controls.length">
                                            {{row?.document_version_content?.clause_number}}. {{row?.document_version_content?.title}}
                                        </td>
                                        <!-- <td [attr.rowspan]="row?.document_version_children_contents.length?getSubClauseCountSpan(row?.document_version_children_contents.length,row.control_assessment_document_version_content_controls.length):row.control_assessment_document_version_content_controls.length" >
                                            <div *ngFor="let child of row?.document_version_children_contents">
                                                {{child?.document_version_content?.clause_number}}. {{child?.document_version_content?.title}} 
                                            </div>
                                            <div *ngIf="row?.document_version_children_contents.length==0">
                                                {{AppStore.noContentText}}
                                            </div>
                                         </td> -->
                                         <td [attr.rowspan]="row.control_assessment_document_version_content_controls.length" >
                                            <div *ngFor="let child of row?.document_version_children_contents">
                                                {{child?.document_version_content?.clause_number}}. {{child?.document_version_content?.title}} 
                                            </div>
                                            <div *ngIf="row?.document_version_children_contents.length==0">
                                                {{AppStore.noContentText}}
                                            </div>
                                         </td>
                                         <!-- <td  [attr.rowspan]="getChildClause(row?.document_version_children_contents).length?row.control_assessment_document_version_content_controls.length/getChildClause(row?.document_version_children_contents).length:row.control_assessment_document_version_content_controls.length">
                                            <div *ngFor="let childClause of getChildClause(row?.document_version_children_contents)">
                                             {{childClause?.document_version_content?.clause_number}}. {{childClause?.document_version_content?.title}} 
                                            </div>
                                           
                                            <div *ngIf="getChildClause(row?.document_version_children_contents).length==0">
                                                {{AppStore.noContentText}}
                                            </div>
                                          </td> -->
                                          <td  [attr.rowspan]="row.control_assessment_document_version_content_controls.length">
                                            <div *ngFor="let childClause of getChildClause(row?.document_version_children_contents)">
                                             {{childClause?.document_version_content?.clause_number}}. {{childClause?.document_version_content?.title}} 
                                            </div>
                                           
                                            <div *ngIf="getChildClause(row?.document_version_children_contents).length==0">
                                                {{AppStore.noContentText}}
                                            </div>
                                          </td>
                                          <td>
                                            {{row?.control_assessment_document_version_content_controls[0]?.control?.title}} 
                                          </td>
                                          <td class="assesment-select">
                                            <ng-select 
                                            [placeholder]="'select_framework_option'|translate" 
                                            [multiple]="false" searchable="true"
                                            bindLabel="title" 
                                            [clearable]="false"
                                            [(ngModel)]="row?.control_assessment_document_version_content_controls[0].business_assessment_framework_option_id"
                                            (change)="updateFrame($event,row?.control_assessment_document_version_content_controls[0])"
                                            >
                                            <ng-option [value]="type.id"
                                                *ngFor="let type of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.business_assessment_framework?.business_assessment_framework_options">
                                                {{type.title}}
                                            </ng-option>
                                        </ng-select>
                                          </td>
                                         
                                          <td>
                                            <div [style.backgroundColor]="row?.control_assessment_document_version_content_controls[0]?.maturity_model_level?.color_code?row?.control_assessment_document_version_content_controls[0]?.maturity_model_level?.color_code:''" style="color:#e2dee7" class="dot-div">
                                                {{row?.control_assessment_document_version_content_controls[0]?.maturity_model_level?.title?row?.control_assessment_document_version_content_controls[0]?.maturity_model_level?.title:AppStore.noContentText}}</div>
                                          </td>
                                          <td class="text-center">
                                            {{row?.control_assessment_document_version_content_controls[0]?.score?row?.control_assessment_document_version_content_controls[0]?.score:'0'}}
                                          </td>
                                          <td   class="align-middle text-center">
                                            <span *ngIf="row?.control_assessment_document_version_content_controls[0]?.control_assessment_action_plans.length">
                                                {{getCountOfClosedActionPlan(row?.control_assessment_document_version_content_controls[0]?.control_assessment_action_plans)}} open /  {{row?.control_assessment_document_version_content_controls[0]?.control_assessment_action_plans.length}} &nbsp;&nbsp;
                                              </span>
                                               <a ><i (click)="addNewActionPlan(row?.control_assessment_document_version_content_controls[0])" class="fa fa-plus mr-1" aria-hidden="true"></i>
                                                   <i *ngIf="row?.control_assessment_document_version_content_controls[0]?.control_assessment_action_plans.length" (click)="listActionPlan(row?.control_assessment_document_version_content_controls[0])" class="fa fa-eye" aria-hidden="true"></i></a>
                                        </td>
        
                                   </tr>
                                </ng-container>
                                <ng-container *ngIf="row.control_assessment_document_version_content_controls.length>1">
                                    <tr *ngFor="let item of row.control_assessment_document_version_content_controls.slice(1,row.control_assessment_document_version_content_controls.length)">
                                        
                                          <td>
                                            {{item?.control?.title}} 
                                          </td>
                                          <td class="assesment-select">
                                            <ng-select 
                                            [placeholder]="'select_framework_option'|translate" 
                                            [multiple]="false" searchable="true"
                                            bindLabel="title" 
                                            [clearable]="false"
                                            [(ngModel)]="item.business_assessment_framework_option_id"
                                            (change)="updateFrame($event,item)"
                                            >
                                            <ng-option [value]="type.id"
                                                *ngFor="let type of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.business_assessment_framework?.business_assessment_framework_options">
                                                {{type.title}}
                                            </ng-option>
                                        </ng-select>
                                          </td>
                                          <td>
                                            <div [style.backgroundColor]="item?.maturity_model_level?.color_code?item?.maturity_model_level?.color_code:''" style="color:#e2dee7" class="dot-div">{{item?.maturity_model_level?.title?item?.maturity_model_level?.title:AppStore.noContentText}}</div>
                                          </td>
                                          <td class="text-center">
                                            {{item?.score?item?.score:'0'}}
                                          </td>
                                          <td (click)="addNewActionPlan(item)"  class="align-middle text-center">
                                           <span *ngIf="item?.control_assessment_action_plans.length">
                                             {{getCountOfClosedActionPlan(item?.control_assessment_action_plans)}} open /  {{item?.control_assessment_action_plans.length}} &nbsp;&nbsp;
                                           </span>
                                            <a ><i (click)="addNewActionPlan(item)" class="fa fa-plus mr-1" aria-hidden="true"></i>
                                                <i *ngIf="item?.control_assessment_action_plans.length" (click)="listActionPlan(item)" class="fa fa-eye" aria-hidden="true"></i></a> 
                                        </td>
                                    </tr>
                                </ng-container>
                                
                            </ng-container>
                           
                            

                              <!-- <tr *ngFor="let item of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.control_assessment_document_version_contents">
                                  <td style="width: 14%;">{{item?.document_version_content?.clause_number}}. {{item?.document_version_content?.title}}</td>
                                  <td style="width: 14%;">
                                    <div *ngFor="let child of item?.document_version_children_contents">
                                        {{child?.document_version_content?.clause_number}}. {{child?.document_version_content?.title}} 
                                    </div>
                                    <div *ngIf="item?.document_version_children_contents.length==0">
                                       NA
                                    </div>
                                 </td>
                                  <td style="width: 14%;">
                                    <div *ngFor="let childClause of getChildClause(item?.document_version_children_contents)">
                                     {{childClause?.document_version_content?.clause_number}}. {{childClause?.document_version_content?.title}} 
                                    </div>
                                    <div *ngIf="getChildClause(item?.document_version_children_contents).length==0">
                                         NA
                                    </div>
                                  </td>
                                  <td style="width:58%" colspan="4">
                                    <table>
                                        <tr *ngFor="let row of getAllControlsMainClause(item)">
                                            <td style="width:25%">
                                                {{row?.control?.title}} 
                                            </td>
                                            <td style="width:25%">
                                                <ng-select 
                                                [placeholder]="'select_framework_option'|translate" 
                                                [multiple]="false" searchable="true"
                                                bindLabel="title" 
                                                [(ngModel)]="row.business_assessment_framework_option_id"
                                                (change)="updateFrame($event,row)"
                                                >
                                                <ng-option [value]="type.id"
                                                    *ngFor="let type of ControlAssessmentDetailsStore?.indiviaulControlAssessment?.business_assessment_framework?.business_assessment_framework_options">
                                                    {{type.title}}
                                                </ng-option>
                                            </ng-select>
                                            </td>
                                            <td style="width:25%">
                                                <div class="dot-div red-dot">NA</div>
                                            </td>
                
                                         <td (click)="addNewActionPlan(row)" style="width:25%;cursor: pointer;" class="align-middle text-center">
                                            <a >NA</a> 
                                        </td>
                                        </tr>
                                        <tr *ngIf="getAllControlsMainClause(item).length==0">
                                            <td style="width:58%" colspan="4">NA</td>
                                        </tr>
                                    </table>
                                  </td>
                                 
                                  
                              </tr>
                               -->
                              
                              
                           </tbody>
                        </table>
                      </div>
                  </div>
             </div>
             
          </div>
      </div>



 
              
          

      



       


      


       

     
    </div>
 </main>
 <div class="modal modal-style-1 fade popup-full-width" id="add-business-framework-popup" data-keyboard="false"
   data-backdrop="static" #formModal>
  
   <app-add-action-plan-control-assessment *ngIf="actionPlanModalObject.type" [source]="actionPlanModalObject">

   </app-add-action-plan-control-assessment>

</div>
