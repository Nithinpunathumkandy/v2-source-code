<div #plainDev></div>
<nav class="edit-bar" data-toggle="affix" #navigationBar>
    <app-breadcrumb-menu></app-breadcrumb-menu>
    <app-sub-menu></app-sub-menu>
</nav>
<main class="mt-3 organization-page">
    <div class="container-fluid" *mobxAutorun>
        <div class="organization-form-page">
            <form [formGroup]="form" id="regForm" class="organization-multi-stup-form multi-stup-form-common" >
                <!-- Circles which indicates the steps of the form: -->
                <div id="header-sroll-form" class="form-indicates-sec clearfix" #formSteps>
                    <span class="step pointer" style="width: 33.33%;" (click)="changeStep(0)"><span class="multi-form-nbr">1</span>{{'info' | translate}}</span>
                    <span class="step pointer" style="width: 33.33%;" (click)="changeStep(1)"><span class="multi-form-nbr">2</span>{{'input_details' | translate}}</span>
                    <span class="step pointer" style="width: 33.33%;" (click)="changeStep(2)"><span class="multi-form-nbr">3</span>{{'preview_save' | translate}}</span>
                </div>
                <!-- One "tab" for each step in the form: -->
                <!-- tab start -->
                <div class="tab">
                    <div class="row">
                        <!-- <div class="col-lg-3 col-sm-3">
                            <div class="form-group">
                                <label for="name"> {{'kpi_code' | translate}}<span class="form-error">*</span></label>
                                <input type="text" 
                                    class="form-control" 
                                    formControlName="reference_code"
                                    [placeholder]="'enter_the_kpi_code' | translate">
                                <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.reference_code">
                                    {{formErrors.reference_code}}
                                </p>
                            </div>
                        </div> -->

                            <div class="col-sm-12 col-lg-12">
                                <div class="form-group">
                                    <label for="name">{{'kpi' | translate}}<span class="form-error">*</span></label>
                                    <div class="clearfix d-flex">
                                        <div class="multiple-plain-ngselect w-100">
                                            <ng-select [placeholder]="'select_kpi' | translate" [multiple]="false"
                                                [items]="KpiMasterStore.kpis"
                                                formControlName="kpi_id" (open)="getKpi()"
                                                (search)="searchKpi($event)" bindLabel="title">

                                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                    {{ item.title }}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-index="index">
                                                    {{ item.title }}
                                                </ng-template>
                                            </ng-select>
                                            <p class="pt-1" style="color: red;"
                                                *ngIf="formErrors && formErrors.kpi_id">
                                                {{formErrors.kpi_id}}
                                            </p>
                                        </div>
                                        <button class="btn multi-add-user ml-2" style="width: 42px;" *ngIf="currentTab==0 && AuthStore.getActivityPermission(5356,'CREATE_KPI')"
                                            (click)="kpiModalAdd()"><i
                                                class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>


                            <div class="col-sm-12">
                                <div class="form-group add-kpi-textarea">
                                    <label for="name"> {{'description' | translate}}</label>
                                    <span class="float-right">
                                        <p class="text-grey mb-0">{{form?.value.description != null ?
                                            form?.value.description?.length : 0}}
                                            {{'characters' | translate}}</p>
                                    </span>
                                    <textarea class="form-control" 
                                        rows="11" 
                                        id="description" 
                                        formControlName="description"
                                        [placeholder]="'write_a_short_description_of_the_kpi' | translate"></textarea>
                                    <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.description">
                                        {{formErrors.description}}
                                    </p>
                                </div>
                            </div>

                            <div class="col-lg-12 col-sm-12">
                                <div class="form-group">
                                    <a class="text-light-blue" data-toggle="modal" (click)="organisationChanges()"
                                        style="border-bottom: 1px solid;">{{'change_organization_unit' | translate}}</a>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="name"> {{'start_date' | translate}} <span class="form-error">*</span></label>
                                    <div class="input-group date-picker">
                                        <input class="form-control cal4" formControlName="start_date" [attr.placeholder]= datePlaceholder
                                            (click)="startDateInput.toggle()" id="start" ngbDatepicker
                                            [maxDate]="form.value.start_date?{year: this.form.value.start_date.year, month: this.form.value.start_date.month, day: this.form.value.start_date.day}:''"
                                            #startDateInput="ngbDatepicker">
        
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary calendar" (click)="startDateInput.toggle()"
                                                type="button"><i class="fas fa-calendar-alt"></i></button>
                                        </div>
                                    </div>
                                    <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.start_date">
                                        {{formErrors.start_date}}</p>
                                </div>
                            </div>

                            <div class="col-lg-6 col-sm-12">
                                <div class="form-group">
                                    <label for="name">{{'kpi_review_frequency' | translate}}<span class="form-error">*</span></label>
                                    <div class="clearfix">
                                        <div class="multiple-plain-ngselect">
                                            <ng-select [items]="KpiReviewFrequenciesStore.allItems"
                                                [placeholder]="'select_kpi_review_frequency' | translate" 
                                                [multiple]="false"
                                                formControlName="kpi_review_frequency_id" 
                                                (open)="getKpireviewfrequency()"
                                                (clear)="getKpireviewfrequency()"
                                                (search)="searchKpireviewfrequency($event)"
                                                bindLabel="title">
                                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                    {{item?.title?.length > 60 ? (item.title | slice:0:60)+' ...' :
                                                    item.title}}<span aria-hidden="true" (click)="clear(item)"
                                                        style="border:none;" class="ng-value-icon left">×</span>
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-index="index">
                                                    {{item?.title?.length > 80 ? (item.title | slice:0:80)+' ...' :
                                                    item.title}}
                                                </ng-template>
                                            </ng-select>
                                            <p class="pt-1" style="color: red;"
                                                *ngIf="formErrors && formErrors.kpi_review_frequency_id">
                                                {{formErrors.kpi_review_frequency_id}}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 col-sm-12">
                                <div class="form-group">
                                    <label> {{'responsible_users' | translate}} <span class="form-error">*</span></label>
                                    <div class="clearfix d-flex">
                                        <div class="multiple-plain-ngselect w-100">
                                            <ng-select #responsibleUsers 
                                                bindLabel="email"
                                                [items]="UsersStore.usersList" 
                                                labelForId="responsible_user_ids" 
                                                [placeholder]="'select_responsible_users' | translate" 
                                                multiple="true"
                                                formControlName="responsible_user_ids" 
                                                [closeOnSelect]="false" [searchFn]="customSearchFn"
                                                (change)="searchListclickValueClear(responsibleUsers)" 
                                                (search)="searchUsers($event)"
                                                (clear)="getAllUsers()" 
                                                (open)="getAllUsers()">
    
                                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                    <img *ngIf="item.image_token || item.image" class="ng-select-user-display"
                                                        height="15" width="15"
                                                        [attr.src]="item.image_token ? createImagePreview('user-profile-picture',item.image_token) : createImagePreview('user-profile-picture',item.image.token)"
                                                        onerror="this.src='/assets/images/user-demo2.png'" />
                                                    <img *ngIf="!item.image_token && !item.image" class="ng-select-user-display"
                                                        height="15" width="15" [attr.src]="getDefaultImage()" />
                                                    <b style="padding-left: 3px;">{{getStringsFormatted([item.first_name,item.last_name],80,'
                                                        ') | titlecase}}</b><span aria-hidden="true" (click)="clear(item)"
                                                        style="border:none;" class="ng-value-icon left">×</span>
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-index="index">
                                                    <div class="user-post-department-pic">
                                                        <img *ngIf="item.image_token || item.image"
                                                            class="ng-select-user-display" height="15" width="15"
                                                            [attr.src]="item.image_token ? createImagePreview('user-profile-picture',item.image_token) : createImagePreview('user-profile-picture',item.image.token)"
                                                            onerror="this.src='/assets/images/user-demo2.png'" />
                                                        <img *ngIf="!item.image_token && !item.image"
                                                            class="ng-select-user-display" height="15" width="15"
                                                            [attr.src]="getDefaultImage()" />
                                                    </div>
                                                    <div class="user-post-department-div">
                                                        <b>{{getStringsFormatted([item.first_name,item.last_name],80,' ') |
                                                            titlecase}}</b>
                                                        <p class="user-post-department-multiple">
                                                            {{getStringsFormatted([item.designation_title,'
                                                            '+item.department],80,',')}}</p>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.responsible_user_ids">
                                                {{formErrors.responsible_user_ids}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 col-sm-12" *ngIf="OrganizationGeneralSettingsStore?.organizationSettings?.is_ms_type">
                                <div class="form-group">
                                    <label for="name"> {{'ms_type' | translate}}</label>
                                    <div class="clearfix">
                                        <div class="multiple-plain-ngselect">
                                            <ng-select 
                                                [placeholder]="'select_ms_type' | translate"
                                                [items]="MsTypeStore.msTypeDetails" 
                                                [multiple]="false"
                                                formControlName="ms_type_organization_id" (open)="getMsType()"
                                                (search)="searchMsType($event)" bindLabel="ms_type_title">
                                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                    <label class="mb-0">{{item?.ms_type_title?.length > 60 ?
                                                        (item.ms_type_title | slice:0:60)+' ...' : item.ms_type_title}}<span
                                                            style="color: #7c7a7a;">V
                                                            {{item.ms_type_version_title}}</span></label><span
                                                        aria-hidden="true" (click)="clear(item)" style="border:none;"
                                                        class="ng-value-icon left">×</span>
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-index="index">
                                                    <label class="mb-0">{{item?.ms_type_title?.length > 80 ?
                                                        (item.ms_type_title | slice:0:80)+' ...' : item.ms_type_title}}<span
                                                            style="color: #7c7a7a;">V
                                                            {{item.ms_type_version_title}}</span></label>
                                                </ng-template>
                                            </ng-select>
                                            <p class="pt-1" style="color: red;"
                                                *ngIf="formErrors && formErrors.ms_type_organization_id">
                                                {{formErrors.ms_type_organization_id}}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                    </div>








                    <div calss="row">
                        <div>
                            <div class="form-group">
                            <label>{{'ms_type' | translate}} &amp; {{'clauses' | translate}}</label>
                                <ng-container *ngIf="msTypeClauses.length==0" >
                                    <app-context-no-data [sourceData] = "{
                                        noData:'no_items_available', border: false, imageAlign: 'left'
                                    }"></app-context-no-data>
                                </ng-container>
            
                                <div *ngIf="msTypeClauses.length!=0" class="common-tab-md clearfix active-right-border-none hc-report-tab-style mb-3">
                                    <div class="tab-common-left-md">
                                        <div class=" issues-tab"><!-- tab menu start -->
                                            <ul class="nav nav-tabs nav-tabs--vertical nav-tabs--left vertical-tab" role="navigation">
                                                <li class="nav-item"> <a href="#clauses1" class="nav-link active" data-toggle="tab" role="tab" aria-controls="lorem" aria-selected="false" data-original-title="" title="">{{form.value?.ms_type_organization_id?.ms_type_title}}<span class="small-text-tab">V {{form.value?.ms_type_organization_id?.ms_type_version_title}}</span></a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="tab-common-left-content-m cmn-bdr padding-bottom-none" style="min-height: 180px;">
                                        <div class="tab-content">
                                            <div class="tab-pane fade active show" id="clauses1" role="tabpanel">
                                                <div class="panel-group panel-drop-sections" id="jd" role="tablist" aria-multiselectable="true">
                                                    <div class="panel panel-default">
                                                        <ng-container *ngFor="let item of msTypeClauses; let i = index"> 
                                                            <div 
                                                                class="panel-heading"
                                                                [class.active]="i==feastActtiveClassFlagIndexId"
                                                                role="tab" 
                                                                [id]="'panel_head_'+i"
                                                                >
                                                                <div class="panel-title panel-title-check">
                                                                    <a (click)="feastActtiveClassFlag(i)" role="button" data-toggle="collapse" href="#ceo11" aria-expanded="true" aria-controls="collapseOne" class="">
                                                                        <h5 class="width96pc mt-0 pl-5">
                                                                            {{item?.clause_number}}- {{item?.title}} <span class="drop-down-icone"><i class="fas fa-chevron-down"></i></span> </h5>
                                                                    </a>
                                                                    <div class="custom-control white-cbox custom-checkbox drop-check-new">
                                                                        <input 
                                                                            type="checkbox" 
                                                                            class="custom-control-input" 
                                                                            [name]="generateIdforString(item?.id)" 
                                                                            [id]="generateIdforString(item?.id)"
                                                                            [checked]="checkedItem(item?.id)"
                                                                            (change)="changeCheckItemStatus($event, item?.id)">
                                                                        <label class="custom-control-label align-label-check" [for]="generateIdforString(item?.id)"></label>
                                                                    </div>

                                                                </div>
                                                            </div>
                                                            <div [id]="i" 
                                                                class="panel-collapse collapse " 
                                                                [class.show]="i==feastActtiveClassFlagIndexId"
                                                                role="tabpanel" aria-labelledby="headingOne" 
                                                                data-parent="#ceo11" >
                                                                <div class="panel-body bg-white">
                                                                    <ng-container *ngIf="item?.children?.length==0">
                                                                        <app-context-no-data [sourceData] = "{
                                                                            noData:'no_items_available', border: false, imageAlign: 'center'
                                                                        }"></app-context-no-data>
                                                                    </ng-container>
                                                                    <ng-container *ngIf="item?.children?.length>0">
                                                                        <ng-container *ngFor="let row of item?.children">
                                                                            <div>
                                                                                <div class="custom-control white-cbox custom-checkbox">
                                                                                    <input 
                                                                                        type="checkbox" 
                                                                                        class="custom-control-input" 
                                                                                        [name]="generateIdforString(item?.id)" 
                                                                                        [id]="generateIdforString(item?.id)"
                                                                                        [checked]="checkedItem(row?.id)"
                                                                                        (change)="changeCheckItemStatus($event, row?.id)">
                                                                                    <label class="custom-control-label align-label-check smoothe-slide" [for]="generateIdforString(item?.id)"> {{row?.clause_number}} {{row?.title}}</label>
                                                                                </div>
                                                                            </div>
                                                                            <app-ms-clause-loop [children]="row?.children"></app-ms-clause-loop>

                                                                        </ng-container>
                                                                    </ng-container>
                                                                </div>
                                                            </div>
                                                        </ng-container>

                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
















                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="name" class="label-style mb-0"> {{'support_files' | translate}}</label>

                                <!-- Common File Upload Starts Here -->
                                <div class="scroll-documents" #uploadArea>
                                    <div class="thumb-pics-bg thumb-pics-col-4 clearfix thumb-pics-fix-text"
                                        style="padding-top: 0;">
                                        <div class="thumb-pics">
                                            <div class="question-circle-inp" style="margin-right: 7px;">
                                                <i class="far fa-question-circle"></i>
                                                <div class="message-password-inp">
                                                    <p class="mb-0">{{'allowed_file_types' | translate}}
                                                        {{OrganizationGeneralSettingsStore.organizationSettings?.support_file_allowed_types.toString()}}
                                                    </p>
                                                </div>
                                            </div>

                                            <div class="form-group form-group-upload">
                                                <div class="darag-dropifile-upload">
                                                    <div class="d-flex justify-content-center align-items-center text-center">
                                                        <div>
                                                            <img src="/assets/images/drag-pic.png" alt="image"
                                                                class="drag-pic-files">
                                                            <div class="drag-file-name"> {{'select_or_upload_your_file_here' | translate}} </div>
                                                            <div class="upload-btn-wrapper">
                                                                <button (click)="openFileUploadModal()" type="button"
                                                                    class="btn">{{'browse_files' | translate}}</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="thumb-pics"
                                            *ngFor="let docs of fileUploadPopupStore.displayFiles ;let i = index">
                                            <div class="upload-pics edit-option" data-toggle="modal">
                                                <div *ngIf="docs.id && !docs.preview" class="browse-form-pic"
                                                    [ngStyle]="{'background': 'url('+createImageUrl('document-version',docs?.token)+') no-repeat'}">
                                                </div>
                                                <div *ngIf="docs.preview" class="browse-form-pic"
                                                    [ngStyle]="{'background': 'url(' + docs?.preview + ') no-repeat 0 0 / cover'}">
                                                </div>
                                                <div class="browse-form-name clearfix">
                                                    <div class="float-left">
                                                        <h6>{{docs.title?docs.title:docs.name?docs.name:docs.version_title?docs.version_title:"NA"}}.{{docs.ext}}
                                                        </h6>
                                                        <span *ngIf="docs.is_kh_document" class="mr-2 cmn-clr"><i
                                                                class="fas fa-book"></i></span>
                                                        <span *ngIf="!docs.is_kh_document" class="mr-2 cmn-clr"><i
                                                                class="fas fa-laptop"></i></span>
                                                        <span>{{docs.size/1048576 | number:'0.2-2'}}MB</span>
                                                    </div>
                                                    <div class="browse-logo">
                                                        <img *ngIf="checkExtension(docs.ext,'image') != -1" class="folder-picher"
                                                            src="/assets/images/jpg-icone.png">
                                                        <img *ngIf="checkExtension(docs.ext,'doc') != -1" class="folder-picher"
                                                            src="/assets/images/word-icone.png">
                                                        <img *ngIf="checkExtension(docs.ext,'pdf') != -1" class="folder-picher"
                                                            src="/assets/images/pdf-icone.png">
                                                        <img *ngIf="checkExtension(docs.ext,'excel') != -1" class="folder-picher"
                                                            src="/assets/images/excel-icone.png">
                                                        <img *ngIf="checkExtension(docs.ext,'video') != -1" class="folder-picher"
                                                            src="/assets/images/md-video.png">
                                                        <img *ngIf="checkExtension(docs.ext,'audio') != -1" class="folder-picher"
                                                            src="/assets/images/md-audio.png">
                                                        <img *ngIf="checkExtension(docs.ext,'ppt') != -1" class="folder-picher"
                                                            src="/assets/images/md-ppt.png">
                                                    </div>
                                                </div>
                                                <div class="edit-option-show">
                                                    <a (click)="removeDocument(docs)"><i class="fas fa-trash"></i></a>
                                                </div>
                                            </div>
                                        </div>


                                    </div>
                                </div>
                                <!-- Common File Upload Ends Here -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- tab end -->

                <!-- tab start -->
                <div class="tab">
                    <div class="row">
                        <div class="col-lg-6 col-sm-12">
                            <div class="form-group">
                                <label for="name">{{'kpi_calculation_type' | translate}}<span class="form-error">*</span></label>
                                <div class="clearfix">
                                    <div class="multiple-plain-ngselect">
                                        <ng-select 
                                            [items]="KpiCalculationTypesMasterStore?.allItems"
                                            [placeholder]="'select_kpi_calculation_type' | translate"
                                            formControlName="kpi_calculation_type_id"
                                            [multiple]="false"
                                            (open) = "getkpiCalculationType()"
                                            (search) = "searchkpiCalculationType($event)"
                                            (clear) = "getkpiCalculationType()"
                                            bindLabel="title">
                                            <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                {{item?.title?.length > 60 ? (item.title | slice:0:60)+' ...' :
                                                item.title}}<span aria-hidden="true" (click)="clear(item)"
                                                    style="border:none;" class="ng-value-icon left">×</span>
                                            </ng-template>
                                            <ng-template ng-option-tmp let-item="item" let-index="index">
                                                {{item?.title?.length > 80 ? (item.title | slice:0:80)+' ...' :
                                                item.title}}
                                            </ng-template>
                                        </ng-select>
                                        <p class="pt-1" style="color: red;"
                                            *ngIf="formErrors && formErrors.kpi_calculation_type_id"> {{formErrors.kpi_calculation_type_id}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <div class="form-group">
                                <label for="name"> {{'time_frame_sla' | translate}}</label>
                                <input type="number" 
                                    class="form-control input-number" 
                                    formControlName="time_frame"
                                    (input)="numberValidation($event)"
                                    [placeholder]="'provide_SLA_time_frame' | translate" numbersOnly>
                                <!-- <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.time_frame">
                                    {{formErrors.time_frame}}
                                </p> -->
                                <p class="pt-1" style="color: red;"
                                    *ngIf="form.controls.time_frame?.errors?.pattern" > 
                                    {{'Please enter Numeric value'}}
                                </p>
                            </div>
                        </div>

                        <div class="col-lg-4 col-sm-12">
                            <div class="form-group">
                                <label for="name"> {{'target' | translate}}<span class="form-error">*</span></label>
                                <input type="number" 
                                    class="form-control input-number" 
                                    formControlName="target"
                                    [placeholder]="'target_of_the_kpi' | translate">
                                <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.target">
                                    {{formErrors.target}}
                                </p>
                            </div>
                        </div>

                        <div class="col-lg-2 col-sm-12">
                            <div class="form-group">
                                <label for="name">{{'unit' | translate}}<span class="form-error">*</span></label>
                                <div class="clearfix">
                                    <div class="multiple-plain-ngselect select-width-plus">
                                        <ng-select [placeholder]="'select_unit' | translate" [multiple]="false"
                                            [items]="UnitMasterStore.allItems"
                                            formControlName="unit_id" (open)="getUnit()"
                                            (search)="searchUnit($event)" bindLabel="title">

                                            <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                {{item?.title?.length > 60 ? (item.title | slice:0:60)+' ...' :
                                                item.title}}
                                            </ng-template>
                                            <ng-template ng-option-tmp let-item="item" let-index="index">
                                                {{item?.title?.length > 80 ? (item.title | slice:0:80)+' ...' :
                                                item.title}}
                                            </ng-template>
                                        </ng-select>
                                        <p class="pt-1" style="color: red;"
                                            *ngIf="formErrors && formErrors.unit_id">
                                            {{formErrors.unit_id}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-sm-12">
                            <div class="form-group">
                                <label for="name"> {{'current_value' | translate}}</label>
                                <input type="number" 
                                    class="form-control input-number" 
                                    formControlName="current_value"
                                    [placeholder]="'current_value_of_the_kpi' | translate">
                                <!-- <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.current_value">
                                    {{formErrors.current_value}}
                                </p> -->
                                <!-- <p class="pt-1" style="color: red;" *ngIf="form?.value?.current_value>0?gretherThanCrrentValue():false">
                                    {{"The current value cannot be greater than target"}}
                                </p> -->
                            </div>
                        </div>

                        <div class="col-sm-12 calculate-select" *ngIf="automation">
                            <div class="form-group">
                                <label for="name">{{'data_input' | translate}}<span class="form-error">*</span></label>
                                <div class="d-flex clearfix">
                                    <input type="text" 
                                        class="form-control" 
                                        [ngModelOptions]="{standalone: true}"
                                        [(ngModel)]="newDataInput" 
                                        [placeholder]="'write_a_data_input_the_kpi' | translate"
                                        (keyup)="onKeyDataInput($event)"
                                        (keydown.enter)="newDataInput?addDataInput(newDataInput):''">
                                    <button 
                                        type="button" 
                                        class="btn multi-add-user ml-2" 
                                        style="width: 70px;"
                                        [disabled]="!newDataInput"
                                        (click)="addDataInput(newDataInput)">{{'add' | translate}}</button>
                                </div>
                                <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.data_inputs">
                                    {{formErrors.data_inputs}}
                                </p>
                                <p class="pt-1" style="color: red;" *ngIf="dataInputError">
                                    {{'this_item_is_already_added' | translate}}
                                </p>
                                <div class="row">
                                    <div class="col-lg-6 col-sm-12" *ngFor="let item of dataInputArray;let i =index">
                                        <div class="bg-main data-input-select-box mt-2">
                                            {{item?.title}} - ( {{item?.variable}} )
                                        <span class="tag-data-input-select-box"> {{i+1}} </span>
                                        <span class="close-data-input-select-box" (click)="deleteDataInput(item,i)">x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-sm-12 calculate-select" *ngIf="automation">
                            <div class="form-group">
                                <label for="name"> {{'formula' | translate}}<span class="form-error">*</span></label>
                                <input type="text" 
                                class="form-control" 
                                formControlName="formula"
                                [placeholder]="'formula_of_the_kpi' | translate"
                                [readonly]="dataInputArray.length==0"
                                (input)="formulaCheck($event)"
                                >
                                <p class="pt-1" style="color: red;" *ngIf="formulaError">
                                    ({{formulaError}}) - {{'item_not_found_in_input_data' | translate}}
                                </p>
                                <p class="pt-1" style="color: red;" *ngIf="forumlaNotFillError">
                                    ({{forumlaNotFillError}}) - {{'this_data_input_variable_is_missing' | translate}}
                                </p>
                                <p class="pt-1" style="color: red;" *ngIf="formulaSymbolError">
                                    {{'this_special_characters_not_valid_here' | translate}} ( {{formulaSymbolError}} )
                                </p>
                                <p class="pt-1" style="color: red;" *ngIf="formErrors && formErrors.formula">
                                    {{formErrors.formula}}
                                </p>
                            </div>
                        </div>

                    </div>
                </div>
                <!-- tab end -->



                <!-- tab start -->
                <div class="tab">
                    <div class="bg-white">
                        <div class="row">
                            <div class="col-lg-12 col-sm-12 padding-right-0">
                                <div class="bg-white min-height-590">
                                    <div class="issue-top-sec">
                                        <div class="clearfix">
                                        <h5 class="d-inline-block cmn-head-style label-tag-style">
                                            <span class="issue-smoal-head-text">
                                                #{{ KpisStore.individualKpiDetails?.reference_code ? KpisStore.individualKpiDetails?.reference_code : AppStore.noContentText }}
                                            </span> {{ KpisStore.individualKpiDetails?.kpi?.title ?KpisStore.individualKpiDetails?.kpi?.title : AppStore.noContentText }}  <span class="draft-tag label-tag-style-tag label-left-arow-tag ml-3" 
                                                [ngClass]="KpisStore.individualKpiDetails?.kpi_management_status?.status?.label ? KpisStore.individualKpiDetails?.kpi_management_status?.label+'-dot' : ''"
                                                style="line-height: 16px; vertical-align: middle; margin-top: -5px; display: inline-block;"> {{ KpisStore.individualKpiDetails?.kpi_management_status?.type | titlecase}}</span></h5>
                                        </div>
                                        <p style="white-space: pre-wrap;" *ngIf="KpisStore.individualKpiDetails?.description">{{KpisStore.individualKpiDetails?.description}} </p>
                                    </div>

                                    <div class="row">
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'kpi_review_frequency' | translate}} </h6>
                                            <p>{{KpisStore.individualKpiDetails?.kpi_review_frequency?.title? KpisStore.individualKpiDetails?.kpi_review_frequency?.title: AppStore.noContentText}}</p>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'time_frame_sla' | translate}}  </h6>
                                            <p *ngIf="KpisStore.individualKpiDetails?.time_frame>1">{{ KpisStore.individualKpiDetails?.time_frame? KpisStore.individualKpiDetails?.time_frame :  AppStore.noContentText  }}  {{'days' | translate}}  </p>
                                            <p *ngIf="KpisStore.individualKpiDetails?.time_frame==1">{{ KpisStore.individualKpiDetails?.time_frame? KpisStore.individualKpiDetails?.time_frame :  AppStore.noContentText  }}  {{'day' | translate}}  </p>
                                            <p *ngIf="!KpisStore.individualKpiDetails?.time_frame">{{ AppStore.noContentText  }} </p>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'kpi_calculation_type' | translate}} </h6>
                                            <p>{{ KpisStore.individualKpiDetails?.calculation_type ? KpisStore.individualKpiDetails?.calculation_type?.kpi_calculation_type_language[0]?.pivot?.title : AppStore.noContentText }}</p>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'current_value' | translate}} </h6>
                                            <p>{{ KpisStore.individualKpiDetails?.current_value? KpisStore.individualKpiDetails?.current_value: AppStore.noContentText}} {{KpisStore.individualKpiDetails?.unit? KpisStore.individualKpiDetails?.unit?.title: AppStore.noContentText}}</p>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'target' | translate}} </h6>
                                            <p>{{ KpisStore.individualKpiDetails?.target? KpisStore.individualKpiDetails?.target: AppStore.noContentText}} {{KpisStore.individualKpiDetails?.unit? KpisStore.individualKpiDetails?.unit?.title: AppStore.noContentText}}</p>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'unit' | translate}} </h6>
                                            <p>{{ KpisStore.individualKpiDetails?.unit? KpisStore.individualKpiDetails?.unit?.title: AppStore.noContentText}}</p>
                                        </div>
                                    </div>

                                    <div class="row">

                                        <div class="col-xl-4 col-lg-6 col-sm-6"  [ngStyle]="{display: !OrganizationLevelSettingsStore.organizationLevelSettings?.is_division ? 'none':'block'}">
                                            <div>
                                                <h6>{{'divisions' | translate}}</h6>
                                                <div class="loop-cmn-p">
                                                    <p
                                                        *ngFor=" let div of KpisStore.individualKpiDetails?.divisions ; let isLast=last">
                                                        {{div.title}}{{isLast ? '' : ',' }}</p>
                                                    <p *ngIf="KpisStore.individualKpiDetails?.divisions?.length==0">{{AppStore.noContentText}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6" [ngStyle]="{display: !OrganizationLevelSettingsStore.organizationLevelSettings?.is_department ? 'none':'block'}">
                                            <div>
                                                <h6>{{'departments' | translate}}</h6>
                                                <div class="loop-cmn-p">
                                                    <p
                                                        *ngFor=" let dept of KpisStore.individualKpiDetails?.departments ; let isLast=last">
                                                        {{dept.title}}{{isLast ? '' : ',' }}</p>
                                                    <p *ngIf="KpisStore.individualKpiDetails?.departments?.length==0">{{AppStore.noContentText}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-4 col-lg-6 col-sm-6" [ngStyle]="{display: !OrganizationLevelSettingsStore.organizationLevelSettings?.is_section ? 'none':'block'}">
                                            <div>
                                                <h6>{{'sections' | translate}}</h6>
                                                <div class="loop-cmn-p">
                                                    <p
                                                        *ngFor=" let section of KpisStore.individualKpiDetails?.sections ; let isLast=last">
                                                        {{section.title}}{{isLast ? '' : ',' }}</p>
                                                    <p *ngIf="KpisStore.individualKpiDetails?.sections?.length==0">{{AppStore.noContentText}}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-xl-4 col-lg-6 col-sm-6"  [ngStyle]="{display: !OrganizationLevelSettingsStore.organizationLevelSettings?.is_sub_section ? 'none':'block'}">
                                            <div>
                                                <h6>{{'sub_sections' | translate}}</h6>
                                                <div class="loop-cmn-p">
                                                    <p
                                                        *ngFor=" let sub_section of KpisStore.individualKpiDetails?.sub_sections ; let isLast=last">
                                                        {{sub_section.title}}{{isLast ? '' : ',' }}</p>
                                                    <p *ngIf="KpisStore.individualKpiDetails?.sub_sections?.length==0">{{AppStore.noContentText}}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div *ngIf="KpisStore.individualKpiDetails?.start_date" class="col-xl-4 col-lg-6 col-sm-6">
                                            <h6> {{'start_date' | translate}} </h6>
                                            <P>
                                                {{ KpisStore.individualKpiDetails?.start_date | date:
                                                    OrganizationGeneralSettingsStore?.organizationSettings?.date_format}}
                                            </P>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-xl-12 col-lg-12 col-sm-12">
                                            <h6>{{'responsible_users' | translate}}</h6>
                    
                                            <div class="pb-3" *ngIf="KpisStore.individualKpiDetails?.responsible_users?.length > 3">
                                                <ul class="arci-user-tab-dtl workflow-lst-pics-loop clearfix" 
                                                    >
                                                    <li class="rounde-hov-bg"
                                                    *ngFor="let user of KpisStore.individualKpiDetails?.responsible_users;let i=index">
                                                        <app-user-popup-box [showName]="false" [source]="getEmployeePopupDetails(user)"></app-user-popup-box>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="row" *ngIf="!(KpisStore.individualKpiDetails?.responsible_users?.length > 3)" >
                                                <div class="col-xl-3 col-lg-4 col-sm-6 animation-pulse"
                                                    *ngFor="let user of KpisStore.individualKpiDetails?.responsible_users;let i=index">
                                                        <div class="label-and-user-pic">
                                                            <app-user-popup-box [source]="getEmployeePopupDetails(user)"></app-user-popup-box>
                                                        </div>
                                                </div>
                                            </div>
                    
                                            <p *ngIf="KpisStore.individualKpiDetails?.responsible_users.length==0">
                                                {{AppStore.noContentText}}
                                            </p>
                                        </div>
                                    </div>
                    
                                    <!-- <div class="row" *ngIf="automation">
                                        <div class="col-md-12">
                                            <h6> {{'data_inputs' | translate}} </h6>
                                            <ng-container *ngIf="KpisStore.individualKpiDetails?.data_inputs?.length>0" >
                                                <div class="bg-main data-input-select-box mt-2 col-md-6" *ngFor="let item of KpisStore.individualKpiDetails?.data_inputs; index as i ">
                                                    {{item?.title}} ( {{item?.variable}} )
                                                    <span class="tag-data-input-select-box">{{i+1}}</span>
                                                </div>
                                            </ng-container>
                                            <p *ngIf="KpisStore.individualKpiDetails?.data_inputs?.length==0"> {{ AppStore.noContentText }}</p>
                                        </div>
                                    </div> -->

                                    <div class="row" *ngIf="automation && KpisStore.individualKpiDetails?.data_inputs?.length>0">
                                        <div class="col-lg-6 col-sm-12" *ngFor="let item of KpisStore.individualKpiDetails?.data_inputs; index as i ">
                                            <div class="bg-main data-input-select-box mt-2">
                                                {{item?.title}} - ( {{item?.variable}} )
                                            <span class="tag-data-input-select-box"> {{i+1}} </span>
                                            </div>
                                            <p *ngIf="KpisStore.individualKpiDetails?.data_inputs?.length==0"> {{ AppStore.noContentText }}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="row" *ngIf="automation">
                                        <div class="col-xl-12 col-lg-6 col-sm-6">
                                            <h6 class="mt-3"> {{'formula' | translate}} </h6>
                                            <p>{{ KpisStore.individualKpiDetails?.formula ? KpisStore.individualKpiDetails?.formula: AppStore.noContentText }}</p>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-xl-12 ">
                                            <div *ngIf="KpisStore.individualKpiDetails?.ms_type_organization" class="mb-2 mt-2" [ngStyle] = "{display: !OrganizationGeneralSettingsStore?.organizationSettings?.is_ms_type ? 'none':'block'}"> 
                                                <h6 *ngIf="KpisStore.individualKpiDetails?.ms_type_organization">{{'ms_type' | translate}} & {{'clauses' | translate}} </h6>
                                                <label class="outline-tag">{{KpisStore.individualKpiDetails?.ms_type_organization?.ms_type?.title}} <span>{{KpisStore.individualKpiDetails?.ms_type_organization?.ms_type_version?.title}}</span></label> 
                                            </div>
                                        </div>
                                    </div>

                                    <div calss="row">
                                        <div >
                                            <h6 class=""> {{'ms_type' | translate}} &amp; {{'clauses' | translate}}</h6>
                                            <div class="audit-form-table w-100">
                                                <div class="fix-table">
                                                    <ng-container *ngIf="KpisStore.individualKpiDetails?.ms_type_clauses.length==0" >
                                                        <app-context-no-data [sourceData] = "{
                                                            noData:'no_items_available', border: false, imageAlign: 'left'
                                                        }"></app-context-no-data>
                                                    </ng-container>
                                                    <table class="table table-bordered ordinary-table cmn-table-style mb-2" *ngIf="KpisStore.individualKpiDetails?.ms_type_clauses.length!=0">
                                                        <tbody>
                                                        <tr>
                                                            <th class="border-top-0" width="8%">
                                                                #
                                                            </th>
                                                            <th class="border-top-0" width="10%">{{'clause_number'| translate}}</th>
                                                            <th class="border-top-0" width="82%">{{'title'| translate}}</th>
                                                        </tr>
                                                        <tr *ngFor="let row of KpisStore.individualKpiDetails?.ms_type_clauses; let i= index;">
                                                            <td>
                                                                {{i+1}}
                                                            </td>
                                                            <td>{{row?.clause_number? row?.clause_number: AppStore.noContentText}}</td>
                                                            <td>{{row?.title? row?.title: AppStore.noContentText}}</td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                        
                                            </div>
                            
                                        </div>
                                    </div>
                    

                                    <h6 class="">{{'support_files' | translate}}</h6>
                                    <div *ngIf = "KpisStore.individualKpiDetails?.documents.length==0">
                                        <app-context-no-data [sourceData] = "getNoDataSource('left')"></app-context-no-data>
                                    </div>

                                    <div class="thumb-pics-bg thumb-pics-col-4 thumb-pics-fix-text clearfix" style="padding-top: 0">
                                        <div class="thumb-pics" *ngFor="let docs of KpisStore.individualKpiDetails?.documents;let i = index">
                    
                                            <!-- System Files Starts Here -->
                                            <div class="upload-pics edit-option" *ngIf="!docs.document_id"  (click) =  "viewDocument('kpi-document',docs,docs)">
                                                <div class="browse-form-pic"  [ngStyle]="{'background': 'url('+createImageUrl('kpi-document',docs?.token)+') no-repeat'}">
                                                </div>
                                                <div class="browse-form-name clearfix">
                                                <div class="float-left">
                                                    <h6>{{docs.title?docs.title:docs.name?docs.name:docs.version_title?docs.version_title:"NA"}}.{{docs.ext}}
                                                    </h6>
                                                    <span>{{docs.size/1048576 | number:'0.2-2'}}MB</span><span class="text-blue bold pl-2">{{'system' | translate}} </span>
                                                </div>
                                                <div class="browse-logo">
                                                    <img *ngIf="checkExtension(docs.ext,'image') != -1"
                                                        class="folder-picher" src="/assets/images/jpg-icone.png">
                                                    <img *ngIf="checkExtension(docs.ext,'doc') != -1"
                                                        class="folder-picher" src="/assets/images/word-icone.png">
                                                    <img *ngIf="checkExtension(docs.ext,'pdf') != -1"
                                                        class="folder-picher" src="/assets/images/pdf-icone.png">
                                                    <img *ngIf="checkExtension(docs.ext,'excel') != -1"
                                                        class="folder-picher" src="/assets/images/excel-icone.png">
                                                    <img *ngIf="checkExtension(docs.ext,'video') != -1"
                                                        class="folder-picher" src="/assets/images/md-video.png">
                                                    <img *ngIf="checkExtension(docs.ext,'audio') != -1"
                                                        class="folder-picher" src="/assets/images/md-audio.png">
                                                    <img *ngIf="checkExtension(docs.ext,'ppt') != -1"
                                                        class="folder-picher" src="/assets/images/md-ppt.png">
                                                </div>
                                                </div>
                                                <div class="edit-option-show">
                                                    <a><i class="fas fa-download" (click) = "downloadDocumentFile('kpi-document',docs)"></i></a>
                                                </div>
                                            </div> 
                    
                        <!-- System Files Starts Here -->
                        <!-- KnowledgeHub Files Starts Here -->
                                            <div class="upload-pics edit-option" *ngIf="docs.document_id">
                                                <div *ngFor="let mainDoc of docs?.kh_document?.versions" (click) =  "viewDocument('document-version',docs,mainDoc)">
                                                    <div *ngIf="mainDoc.is_latest">
                                                    <div  class="browse-form-pic"  [ngStyle]="{'background': 'url('+createImageUrl('document-version',mainDoc?.token)+') no-repeat'}">
                                                    </div>
                                                        <div class="browse-form-name clearfix">
                                                        <div class="float-left">
                                                        <h6>{{mainDoc.title}}.{{mainDoc.ext}}
                                                        </h6>
                                                        <span>{{mainDoc.size/1048576 | number:'0.2-2'}}MB</span><span class="text-blue bold pl-2">{{'knowledge_hub' | translate}}</span>
                                                        </div>
                                                        <div class="browse-logo">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'image') != -1"
                                                            class="folder-picher" src="/assets/images/jpg-icone.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'doc') != -1"
                                                            class="folder-picher" src="/assets/images/word-icone.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'pdf') != -1"
                                                            class="folder-picher" src="/assets/images/pdf-icone.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'excel') != -1"
                                                            class="folder-picher" src="/assets/images/excel-icone.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'video') != -1"
                                                            class="folder-picher" src="/assets/images/md-video.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'audio') != -1"
                                                            class="folder-picher" src="/assets/images/md-audio.png">
                                                        <img *ngIf="checkExtension(mainDoc.ext,'ppt') != -1"
                                                            class="folder-picher" src="/assets/images/md-ppt.png">
                                                    </div>
                                                        </div>
                                                        <div class="edit-option-show">
                                                        <a><i class="fas fa-download" (click) = "downloadDocumentFile('document-version',docs,mainDoc)"></i></a>
                                                    </div>
                                                    </div>
                                                </div>
                    
                                            
                                            </div>
                        <!-- KnowledgeHub Files Ends Here -->
                    
                                            </div>
                                    </div>
                    
                                    <div class="row">
                                        <div class="col-xl-12">
                                            <hr>
                                            <div class="d-flex flex-row user-list-sm">
                                                <app-user-popup-box [source]="getEmployeePopupDetails( KpisStore.individualKpiDetails?.created_by, KpisStore.individualKpiDetails?.created_at)"
                                                    [activateButtons]="false"></app-user-popup-box>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- tab end -->

                <div style="overflow:auto;">
                    <div class="form-next-page-btns" style="float:left;">
                        <button class="btn btn-active" type="button" id="nextBtn" (click)="nextPrev(1,true)"
                            [disabled]="AppStore.loading || !checkFormObject()|| formulaButtonValidtion()">{{getButtonText(nextButtonText)}}</button>
                        <button *ngIf="currentTab!=2" class="btn" type="button" id="saveBtn" (click)="saveTabDetails()"
                            [disabled]="AppStore.loading || !checkFormObject()|| formulaButtonValidtion()">{{getButtonText('save')}}</button>
                        <button class="btn" type="button" id="prevBtn" (click)="nextPrev(-1)"
                            [disabled]="AppStore.loading">{{getButtonText(previousButtonText)}}</button>
                        <button class="btn" type="button" (click)="confirmCancel()"> {{'cancel' | translate}}</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</main>

<div class="modal modal-style-1 popup-full-width fade" data-keyboard="false" data-backdrop="static" #kpiformModal>
    <app-user-kpi-modal *ngIf="KpisStore.kpiformModal">
    </app-user-kpi-modal>
</div>

<!-- Cancel form -->
<div class="modal modal-style-1 fade" id="delete-popup" #cancelPopup>
    <app-delete-popup [source]="cancelObject"></app-delete-popup>
</div>


<!----------------------- Organization form modal starts here --------------------------->
<div class="modal modal-style-1 popup-full-width fade" data-keyboard="false" data-backdrop="static"
    #organisationChangeFormModal *mobxAutorun>
    <app-organisation-change-modal *ngIf="openModelPopup" [source]="form.value"
        (organizationChangeEvent)="closeOrganizationModal($event)"></app-organisation-change-modal>
</div>


<!-- * Documetn Attach/Upload Common Component Starts Here -->
<div class="modal modal-style-1 popup-full-width fade" data-keyboard="false" data-backdrop="static" #fileUploadModal>
    <!--  [system]="false" System file not need -->
    <app-file-upload-popup *ngIf="fileUploadPopupStore.openPopup" [source]="FileUploadScoreObject" ></app-file-upload-popup>
</div>

<!-- File Preview -->
<div class="modal modal-style-1 popup-full-width fade popup-new-type" id="add-three-popup" data-keyboard="false"
    data-backdrop="static" #filePreviewModal *mobxAutorun>
    <button type="button" class="close" data-dismiss="modal" (click)="closePreviewModal($event)"><i
        class="lni-close"></i><span>{{'esc' | translate}}</span></button>
    <app-preview *ngIf="previewObject" [source]="previewObject" (close)="closePreviewModal($event)"></app-preview>
</div>

