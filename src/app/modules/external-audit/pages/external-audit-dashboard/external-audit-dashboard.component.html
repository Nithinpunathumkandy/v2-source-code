<ng-container *mobxAutorun>
    <div *ngIf="!ExternalAuditDashboardStore?.dashboardLoaded">
        <app-bia-details-loader ></app-bia-details-loader>
    </div>
</ng-container>

<nav class="edit-bar" data-toggle="affix">
    <div class="module-name-block module-name-block-space float-left">
        <a class="dropdown module-title">
           {{'external_audit_dashboard' | translate}}
        </a>
    </div>
    <div class="dropdown edit-dropdown d-xl-none close-page-smol">
        <button type="button" onclick="window.location='finding-details.html';" class="btn btn-small btn-header-db float-right">Finding Details</button>
    </div>


    <ul class="nav nav-pills edit-icons float-right d-none d-xl-block" role="tablist">
        <li>
            <button (click)="routeToFindingDetails()" type="button" class="btn btn-small btn-header-db">Finding
                Details <i class="fas fa-arrow-right ml-2"></i></button>
        </li>
    </ul>


</nav>

<main class="mt-3 acl-page cpf-space-adjust db-small-space-boxes db-layout-150" *ngIf="ExternalAuditDashboardStore.dashboardLoaded">
    <div class="container-fluid">
        

        <div class="row sm-row">
          <div class="col-lg-4 sm-col">
            <div class="bg-white btm-space-10 db-shadow pt-4 pb-4">
                    <div class="row align-items-center">
                        <div class="col-md-4 border-right">
                            <div class="text-center mt-1 mb-1">
                                <h3 class="big-text-four">{{open_count?.count+close_count?.count}}</h3>
                                <h5 class="mb-0">Findings</h5>
                            </div>
                        </div>
                        <div class="col-md-8 text-center">
                            <div class="clearfix pl-3 clearfix d-flex flex-wrap justify-content-between">
                                <div>
                                 <h3 class="big-text-one">{{open_count?.count}}</h3>
                                 <p class="dot-div-new dot-dark-red mb-0">Open</p>
                                </div>
                                <div>
                                 <h3 class="big-text-one">{{close_count?.count}}</h3>
                                 <p class="dot-div-new dot-green mb-0">Closed</p>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
          </div>
          <div class="col-lg-8 sm-col">
            <div class="bg-white btm-space-10 db-shadow pt-4 pb-4">
                    <div class="row align-items-center">
                        <div class="col-md-4 border-right">
                            <div class="text-center">
                                <h3 class="big-text-four">{{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.total}}</h3>
                                <h5 class="mb-0">Action Plan</h5>
                            </div>
                        </div>
                        <div class="col-md-8 text-center">
                            <div class="clearfix align-items-center pl-3 clearfix d-flex flex-wrap justify-content-between">
                                <div>
                                 <h3 class="big-text-one">{{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.open?.count}}</h3>
                                 <p class="dot-div-new dot-dark-red mb-0">Open</p>
                                </div>
                                <div>
                                    <h3 class="big-text-one">NA</h3>
                                    <p class="dot-div-new dot-green mb-0">Resolved</p>
                                </div>
                                <div>
                                    <h3 class="big-text-one">NA</h3>
                                    <p class="dot-div-new dot-dark-red mb-0">Overdue</p>
                                </div>
                                <div class="db-md-screen-center">
                                    <div class="text-center">
                                        <h3 class="big-text-three">NA</h3>
                                        <p class="mb-0">Solved</p>
                                    </div>
                                    <span class="top-arow-db ml-2 text-dark-green"><i class="fas fa-long-arrow-alt-up"></i></span>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
          </div> 
        </div>
        
        <div class="row sm-row">
            <div class="col-lg-4 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">{{'ea_db_audit_by_audit_types' | translate}}</h5>
                    <hr>
                    <div class="dpt-pic-ceo w-100" style="width: 100%; height: 200px"
                        *ngIf="ExternalAuditDashboardStore.AuditByTypeCount.length==0">
                        <app-no-chart-data [source]="'pie'" style="height: 100%;"></app-no-chart-data>
                    </div>
                    <div class="dpt-pic-ceo w-100" style="width: 100%; height: 200px"
                        *ngIf="ExternalAuditDashboardStore.AuditByTypeCount.length!=0">
                        <div id="StatusWiseCountsDiv" style="height: 100%;"></div>
                    </div>

                </div>
            </div>
            <!-- <div class="col-lg-4 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">{{'ea_db_last_5_years_finding_count'|translate}}</h5>
                    <hr>
                    <div class="dpt-pic-ceo w-100" style="width: 100%; height: 200px">
                        <app-no-chart-data [source]="'bar'"></app-no-chart-data>
                    </div>
                </div>
            </div> -->
            <div class="col-lg-4 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">{{'ea_db_audit_by_ms_types' | translate}}</h5>
                    <hr>
                    <div class="dpt-pic-ceo w-100" style="width: 100%; height: 200px"
                        *ngIf="ExternalAuditDashboardStore.auditMsTypes.length==0">
                        <app-no-chart-data [source]="'pie'" style="height: 100%;"></app-no-chart-data>
                    </div>
                    <div class="dpt-pic-ceo w-100" style="width: 100%; height: 200px"
                        *ngIf="ExternalAuditDashboardStore.auditMsTypes.length!=0">
                        <div id="MsTypesDiv" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>  


        <div class="row sm-row">
            <div class="col-lg-5 col-sm-12 sm-col">
                <div class="bg-white btm-space-10 db-shadow pt-4 pb-4">
                    <div class="row align-items-center">
                        <div class="col-md-4 border-right">
                            <div class="text-center">
                                <h3 class="big-text-four">{{open_count?.count+close_count?.count}}</h3>
                                <h5 class="mb-0">Total Findings</h5>
                            </div>
                        </div>
                        <div class="col-md-8 text-center">
                            <div class="clearfix round-type-status-main-bg">
                                <div class="round-type-status-main">
                                    <div class="open-close-status-db d-flex align-items-center status-open">
                                        <div class="round-type-status-value">
                                            <h6 class="mb-0">{{open_count?.percentage}}%</h6>
                                        </div>
                                        <div class="round-type-status-bg rounded-circle">
                                            <div class="round-type-status rounded-circle">
                                                <h5>Open</h5>
                                                <h6 class="mb-0">{{open_count?.count}}</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="round-type-status-main">
                                    <div class="open-close-status-db open-close-status-db-right d-flex align-items-center status-closed">
                                        <div class="round-type-status-bg rounded-circle">
                                            <div class="round-type-status rounded-circle">
                                                <h5>Closed</h5>
                                                <h6 class="mb-0">{{close_count?.count}}</h6>
                                            </div>
                                        </div>
                                        <div class="round-type-status-value">
                                            <h6 class="mb-0">{{close_count?.percentage}}%</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">Finding By Rating Zone / Rating wise</h5>
                    <hr>
                    <div style="min-height: 307px;">
                    <div class="row sm-row ia-db-finding-sec">
                        <div class="col-lg-3 col-sm-4 sm-col">
                            <ng-container *ngFor="let row of ExternalAuditDashboardStore.RiskRatingFindings">
                                <div class="pt-2 pb-3 swot-sec-score-sec">
                                    <h3 class="big-text-one">{{row.findings.count}}</h3>
                                    <p class="dot-div-new dot-normal-violet mb-0 span-dot-color">
                                        <span [ngStyle]="{'background':row.color_code}"></span>{{row.title}}
                                    </p>
                                </div>
                            </ng-container>
                        </div>
                        <div class="col-lg-9 col-sm-8 sm-col">
                            <div class="dpt-pic-ceo w-100" style="width: 100%; height: 250px"
                                *ngIf="showPieNoDataMap">
                                <app-no-chart-data [source]="'pie'"></app-no-chart-data>
                            </div>
                            <div class="dpt-pic-ceo w-100" style="width: 100%; height: 250px"
                            *ngIf="!showPieNoDataMap">
                                <div id="RiskRatingFindingsDiv" style="height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            </div>
            <div class="col-lg-7 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">Top 10 Open Findings</h5>
                    <hr>

                    <div class="slider-db-top-ten-sec ia-db-slider-height" style="min-height: 430px;">
                        <owl-carousel-o [options]="clientOptions">

                            <ng-container *ngIf="ExternalAuditDashboardStore.Top10First?.length!=0">
                                <ng-template carouselSlide>
                                    <div class="bg-white btm-space-10 widg-padding-cmn-small cmn-bdr db-box-link-sec"
                                        *ngFor="let row of ExternalAuditDashboardStore.Top10First; let num=index">
                                        <div
                                            [ngClass]="AuthStore.getActivityPermission(100,'PROCESS_DETAILS') ? 'd-flex align-items-center pointer' : 'd-flex align-items-center'">
                                            <h3 class="mb-0 big-text-two text-black font-weight-600">{{num+1}}</h3>
                                            <div class="w-100 ml-3">
                                                <p class="mb-0 text-black font-weight-600 elips">{{row.title}}
                                                    ({{row.reference_code}})</p>
                                            </div>
                                            <div class="top-ten-right-left-line-type-text" style="width: 150px;">
                                                <div class="left-line-type-text-main d-inline-block">
                                                    <div class="ml-2 left-line-type-text">
                                                        <span
                                                            [attr.class]="'dot-div-new mb-3 dot-'+row.risk_rating_label"></span>
                                                        <h5 class="mb-0 text-black">{{row?.risk_ratings}}</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>
                            </ng-container>
                            <ng-container *ngIf="ExternalAuditDashboardStore.Top10First?.length!=0">
                                <ng-template *ngIf="ExternalAuditDashboardStore.totalItems>5" carouselSlide>
                                    <div class="bg-white btm-space-10 widg-padding-cmn-small cmn-bdr db-box-link-sec"
                                        *ngFor="let row of ExternalAuditDashboardStore.Top10Second; let num=index">
                                        <div class="d-flex align-items-center">
                                            <h3 class="mb-0 big-text-two text-black font-weight-600">{{num+6}}</h3>
                                            <div class="w-100 ml-3">
                                                <p class="mb-0 text-black font-weight-600 elips">{{row.title}}
                                                    ({{row.reference_code}})</p>
                                            </div>
                                            <div class="top-ten-right-left-line-type-text" style="width: 150px;">
                                                <div class="left-line-type-text-main d-inline-block">
                                                    <div class="ml-2 left-line-type-text">
                                                        <span
                                                            [attr.class]="'dot-div-new mb-3 dot-'+row.risk_rating_label"></span>
                                                        <h5 class="mb-0 text-black">{{row?.risk_ratings}}</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>
                            </ng-container>

                        </owl-carousel-o>
                    </div>
                    <ng-container *ngIf="ExternalAuditDashboardStore.Top10First?.length==0">
                        <div class="no-policy-demo-text bg-white d-flex align-items-center w-100 mt-2 p-3"
                            style="min-height: 505px;">
                            <div class="no-policy-demo">
                                <img class="pointer"
                                    [attr.src]="ThemeStructureSettingStore.themeStructureObject.empty_screen ? ThemeStructureSettingStore.themeStructureObject.empty_screen : '/assets/images/empty_screen.png'"
                                    onerror="this.src='assets/images/empty_screen.png'" style="width:200px" />
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>


        <div class="row sm-row">
            <div class="col-lg-5 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">{{'ea_db_findings_by_division' | translate}}</h5>
                    <hr>
                    <div class="text-center ia-db-finding-division db-md-screen-center finding-sec-height-ia-db">
                        <div class="dpt-pic-ceo w-100" style="width: 100%; height: 250px"
                        *ngIf="showPieNoDataMap">
                            <app-no-chart-data [source]="'pie'"></app-no-chart-data>
                        </div>
                        <div class="dpt-pic-ceo w-100"  *ngIf="!showPieNoDataMap">
                            <div id="DivisionFindingsDiv" style="width: 100%; height: 250px"></div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="col-lg-7 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">{{'ea_db_findings_by_risk_rating' | translate}}</h5>
                    <hr>
                    <div class="text-center ia-db-finding-department db-md-screen-center finding-sec-height-ia-db">
                        <div class="dpt-pic-ceo w-100" style="width: 100%; height: 300px" *ngIf="showNoDataBarChart">
                            <app-no-chart-data [source]="'bar'"></app-no-chart-data>
                        </div>
                        <div class="dpt-pic-ceo w-100" *ngIf="!showNoDataBarChart">
                            <div id="DepartmentFindingsBarChartDiv" style="width: 100%; height: 300px"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row sm-row">
            <div class="col-lg-5 col-sm-12 sm-col">
                <div class="bg-white btm-space-10 db-shadow">
                    <div class="row align-items-center db-ia-box-hight-four">
                        <div class="col-md-4 border-right">
                            <div class="text-center">
                                <h3 class="big-text-four">{{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.total}}
                                </h3>
                                <h5 class="mb-0">Action Plan</h5>
                            </div>
                        </div>
                        <div class="col-md-8 text-center">
                            <div class="clearfix round-type-status-main-bg">
                                <div class="round-type-status-main">
                                    <div class="open-close-status-db d-flex align-items-center status-open">
                                        <div class="round-type-status-value">
                                            <h6 class="mb-0">
                                                {{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.open?.percentage}}%
                                            </h6>
                                        </div>
                                        <div class="round-type-status-bg rounded-circle">
                                            <div class="round-type-status rounded-circle">
                                                <h5>Open</h5>
                                                <h6 class="mb-0">
                                                    {{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.open?.count}}
                                                </h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="round-type-status-main">
                                    <div
                                        class="open-close-status-db open-close-status-db-right d-flex align-items-center status-closed">
                                        <div class="round-type-status-bg rounded-circle">
                                            <div class="round-type-status rounded-circle">
                                                <h5>Closed</h5>
                                                <h6 class="mb-0">
                                                    {{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.closed?.count}}
                                                </h6>
                                            </div>
                                        </div>
                                        <div class="round-type-status-value">
                                            <h6 class="mb-0">
                                                {{ExternalAuditDashboardStore?.CorrectiveActionOpenCloseCount?.closed?.percentage}}%
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div class="col-lg-7 col-sm-12 sm-col">
                <div class="row sm-row">
                    <div class="col-lg-4 col-sm-4 col-6 sm-col">
                        <div class="bg-white btm-space-10 db-shadow db-md-screen-center db-ia-box-hight-four">
                            <div>
                                <h3 class="big-text-one">23</h3>
                                <p class="dot-div-new dot-green mb-0">Resolved</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-sm-4 col-6 sm-col">
                        <div class="bg-white btm-space-10 db-shadow db-md-screen-center db-ia-box-hight-four">
                            <div>
                                <h3 class="big-text-one">02</h3>
                                <p class="dot-div-new dot-dark-red mb-0">Overdue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-sm-4 col-12 sm-col">
                        <div class="bg-white btm-space-10 db-shadow db-md-screen-center db-ia-box-hight-four">
                            <div class="text-center">
                                <h3 class="big-text-three">96%</h3>
                                <p class="mb-0">Solved</p>
                            </div>
                            <span class="top-arow-db ml-2 text-dark-green"><i class="fas fa-long-arrow-alt-up"></i></span>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>


        <div class="row sm-row">
            <div class="col-lg-12 col-sm-12 sm-col">
                <div class="bg-white widg-padding-cmn btm-space-10 db-shadow">
                    <h5 class="cmn-head-style m-0">Overdue Action Plans</h5>
                    <hr>

                    <div class="row sm-row">
                        <div class="col-xl-12 col-lg-12 col-sm-12 sm-col">

                            <div class="no-fixed-table">
                                <div class="fix-table" *ngIf = "ExternalAuditDashboardStore.OverdueActionPlans.length > 0">

                                    <table class="table table-bordered ordinary-table cmn-table-style mb-0">
                                        <tbody>
                                            <tr>
                                                <th class="border-top-0" width="4%">#</th>
                                                <th class="border-top-0" width="15%">Audit Finding ID</th>
                                                <th class="border-top-0" width="28%">Corrective Action</th>
                                                <th class="border-top-0" width="25%">Responsible Person</th>
                                                <th class="border-top-0" width="16%">Date</th>
                                                <th class="border-top-0" width="12%">Status</th>
                                            </tr>
                                            <tr
                                                *ngFor="let row of ExternalAuditDashboardStore.OverdueActionPlans| paginate: {currentPage:ExternalAuditDashboardStore.currentPageForOverdue, itemsPerPage:ExternalAuditDashboardStore.itemsPerPageForOverdue,totalItems:ExternalAuditDashboardStore.totalItemsForOverdue};let num=index">
                                                <td class="text-center">{{(ExternalAuditDashboardStore?.currentPageForOverdue - 1) * ExternalAuditDashboardStore?.itemsPerPageForOverdue + (num + 1)}}</td>
                                                <td>#{{row.reference_code}}</td>
                                                <td>{{row.title}}</td>
                                                <td class="cursor-pointer">

                                                    <div class="d-flex flex-row user-list-sm">
                                                        <img *ngIf="row.responsible_user.image_token"
                                                            [attr.src]="createImagePreview('user-profile-picture',row.responsible_user.image_token)"
                                                            width="30px" height="30px" class="rounded-circle"
                                                            onerror="this.src='/assets/images/user-demo2.png'">
                                                        <img *ngIf="!row.responsible_user.image_token"
                                                            [attr.src]="getDefaultImage('user-logo')" width="30px"
                                                            height="30px" class="rounded-circle"
                                                            onerror="this.src='/assets/images/user-demo2.png'">
                                                        <div>
                                                            <h6
                                                                title="{{row.responsible_user.first_name+row.responsible_user.last_name }}">
                                                                {{row?.responsible_user.first_name?.length > 20 ?
                                                                row.responsible_user.first_name?.substring(0,10)+' ...'
                                                                : row.responsible_user.first_name
                                                                }}&nbsp;{{row.responsible_user.last_name?.length > 20 ?
                                                                row.responsible_user.last_name?.substring(0,10)+' ...' :
                                                                row.responsible_user.last_name}}
                                                            </h6>
                                                            <span _ngcontent-nws-c590=""
                                                                wfd-id="801">{{row.responsible_user.designation.title}}</span>

                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="cursor-pointer">
                                                    {{row.target_date | date:
                                                    OrganizationGeneralSettingsStore.organizationSettings?.date_format}}
                                                </td>
                                                <td>
                                                    <div [ngClass]="'dot-div '+ row.corrective_action_status.label">
                                                        {{row.corrective_action_status.title}}</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div *ngIf="ExternalAuditDashboardStore.totalItemsForOverdue>ExternalAuditDashboardStore.itemsPerPageForOverdue"
                                        class="col-sm-12">
                                        <ul class="pagination justify-content-center mt-3">
                                            <div class="list">
                                                <pagination-controls (pageChange)="getOverdueActionPlan($event)" [previousLabel]="'previous' | translate" [nextLabel]="'next' | translate" class="my-pagination">
                                                </pagination-controls>
                                            </div>
                                        </ul>
                                    </div>
                                </div>
                                <app-no-data-list [source]="noDataMsg" [border]="false" *ngIf = "ExternalAuditDashboardStore.OverdueActionPlans.length == 0"></app-no-data-list>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>









    </div>
</main>